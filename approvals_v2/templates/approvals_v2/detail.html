<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í’ˆì˜ì„œ ìƒì„¸ - {{ approval.title }}</title>
{% load static %}
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "ë§‘ì€ ê³ ë”•", sans-serif; margin: 20px; }
    .paper { width: 100%; max-width: 900px; border: 1px solid #000; padding: 20px; box-sizing: border-box; margin: 0 auto; background: #fff; }

    .header-wrapper { display:flex; align-items:flex-start; justify-content:center; margin-bottom: 10px; gap: 12px; }
    .header-left { flex:1; text-align:center; }
    .title-row h1 { margin:0; font-size:36px; letter-spacing:0.4em; }
    .date-row { text-align:center; margin:10px 0 20px 0; font-size:16px; }
    .date-row .date-text { display:inline-block; min-width:160px; padding-bottom:2px; border-bottom:1px solid #000; font-size:14px; }

    /* ===== ê²°ì¬ í…Œì´ë¸” ===== */
    .sign-table{
      margin-left:auto;
      border-collapse:collapse;
      border:1px solid #000;
      background:#fff;
      font-size:13px;
      table-layout: fixed;
    }
    .sign-table th, .sign-table td{
      border:1px solid #000;
      width:90px;
      text-align:center;
      vertical-align:middle;
      padding:0;
    }

    /* í—¤ë”(ê¸°ì•ˆ/ì´ë¬´/íšŒì¥) ì–‡ê²Œ + íšŒìƒ‰ */
    .sign-table th{
      background:#e9ecef;
      height:22px;
      font-size:13px;
      font-weight:600;
      line-height:22px;
    }

    /* ë„ì¥ì¹¸ ë†’ì´ */
    .sign-table .stamp-td{ height:54px; }

    /* ì‹œê°„ì¤„ íšŒìƒ‰ + ì–‡ê²Œ */
    .sign-time-row td{
      background:#e9ecef;
      height:22px;
      font-size:11px;
      color:#333;
      line-height:22px;
    }

    /* td ì•ˆ ì •ì¤‘ì•™ ì •ë ¬ */
    .stamp-cell{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* âœ… ê²°ì¬ ë²„íŠ¼(ì´ˆë¡ ê°•ì¡°) */
    .stamp-click{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:64px;
      height:40px;

      border:2px solid #1e9e48;
      color:#1e9e48;
      background:#e9f7ef;
      border-radius:10px;
      box-shadow:0 0 0 2px rgba(30,158,72,0.15);

      font-weight:700;
      font-size:14px;
      letter-spacing:.08em;
      cursor:pointer;
      user-select:none;
    }
    .stamp-click:hover{ background:#1e9e48; color:#fff; }
    .stamp-click:active{ transform: scale(0.97); }

    /* ìŠ¹ì¸ SVG ë„ì¥ */
    .stamp-svg-wrap{
      width:56px;
      height:56px;
      color:#d60000;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .stamp-svg{ width:100%; height:100%; display:block; }

    /* ìŠ¹ì¸ PNG ë„ì¥ */
    .stamp-img{
      display:block;
      max-width:70px;
      max-height:46px;
      width:auto;
      height:auto;
      margin:0 auto;
    }

    /* ë°˜ë ¤ í‘œì‹œ */
    .stamp-rejected{
      color:#b00020;
      border:2px solid #b00020;
      border-radius:10px;
      padding:8px 12px;
      font-weight:800;
      font-size:14px;
      line-height:1;
    }

    .stamp-empty{ width:56px; height:56px; }

    /* ===== ë³¸ë¬¸ í…Œì´ë¸” ===== */
    .info-table, .subject-table, .content-table { width:100%; border-collapse:collapse; table-layout:fixed; margin-bottom:10px; }
    .info-table th, .info-table td, .subject-table th, .subject-table td, .content-table th, .content-table td {
      border:1px solid #000; padding:6px; font-size:14px;
    }
    .info-table th, .subject-table th, .content-table th { width:80px; text-align:center; background:#f8f8f8; }
    .content-table td { height: 400px; vertical-align: top; overflow:auto; }
    .content-value { white-space:pre-wrap; word-break:break-word; max-width:100%; }
    .content-value img { max-width:100% !important; height:auto !important; display:block; }
    .content-value table { max-width:100% !important; width:100% !important; table-layout:fixed; border-collapse:collapse; }
    .content-value th, .content-value td { word-break:break-word; overflow-wrap:anywhere; }

    .hint { font-size:13px; color:#444; margin-top:10px; }

    .reject-box { margin-top:8px; padding:8px; border:1px solid #000; background:#fafafa; text-align:left; }
    .reject-box .t { font-weight:bold; color:#b00020; margin-bottom:4px; }
    .reject-box .c { white-space:pre-wrap; }

    .done-row{ margin-top:14px; display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .done-msg-left{ color:#0a7c1f; font-weight:bold; flex:1; }
    .done-msg-right{ text-align:right; font-size:13px; line-height:1.5; white-space:nowrap; }

    .btn-row { margin-top: 16px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .btn-link{
      padding:10px 18px;
      font-size:14px;
      cursor:pointer;
      border:1px solid #555;
      border-radius:6px;   /* âœ… border ì•ì— ë¶™ì€ ì˜¤íƒ€ ì œê±° */
      background:#fff;
      text-decoration:none;
      color:#111;
    }


    /* ëª¨ë°”ì¼ */
    @media (max-width:600px){
      body { margin:10px; font-size:13px; }
      .paper { padding:10px; }
      .header-wrapper { flex-direction:column; align-items:stretch; }
      .title-row h1 { font-size:28px; letter-spacing:0.25em; }

      .sign-table th, .sign-table td{ width:72px; }
      .sign-table .stamp-td{ height:50px; }
      .stamp-click{ width:60px; height:38px; font-size:13px; }
      .stamp-img{ max-width:64px; max-height:42px; }

      .done-row{ flex-direction:column; }
      .done-msg-right{ text-align:left; white-space:normal; }
      .content-table td { height:260px; }
    }

    /* ===== ì²¨ë¶€ ===== */
    .attach-box{
      margin-top:12px;
      border:1px solid #000;
      padding:10px;
      background:#fafafa;
    }
    .attach-title{ font-weight:800; margin-bottom:6px; }
    .attach-list{ margin:0; padding-left:18px; }
    .attach-list li{ margin:4px 0; line-height:1.4; }
    .attach-list a{ text-decoration:underline; }
    .attach-meta{ font-size:12px; color:#666; margin-left:6px; }
    @media (max-width:600px){
      .attach-list li{ padding:6px 0; }
    }

    /* ===== ë¡œê·¸ í† ê¸€ ===== */
    .log-toggle{
      margin-top:10px;
      font-size:13px;
      cursor:pointer;
      color:#1f6feb;
      text-decoration:underline;
    }
    .log-box{
      margin-top:8px;
      padding:8px;
      border:1px dashed #999;
      background:#f9f9f9;
      font-size:12px;
    }
    .log-line{ margin-top:4px; }

    /* ===== ê²°ì¬ ëª¨ë‹¬ ë²„íŠ¼(ì•„ì›ƒë¼ì¸) ===== */
    .modal-action-btn{
      width:100%;
      height:60px;
      border-radius:12px;
      font-size:18px;
      font-weight:900;
      letter-spacing:0.08em;
      cursor:pointer;
      user-select:none;

      background:#fff;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;

      gap:10px;
      padding:0 12px;
      margin:0; /* âœ… ë°”ê¹¥ ì—¬ë°±ì€ ì»¨í…Œì´ë„ˆê°€ ê´€ë¦¬ */
    }

    .modal-action-btn:active{ transform:scale(0.99); }
    .modal-action-btn[disabled]{ opacity:0.6; cursor:not-allowed; transform:none; }

    /* ìŠ¹ì¸(ë¹¨ê°• outline) */
    .modal-approve{
      border:2px solid #d1242f;
      color:#d1242f;
    }
    .modal-approve:hover{ background:#fff5f6; }

    /* ë°˜ë ¤(íŒŒë‘ outline) */
    .modal-reject{
      border:2px solid #1f6feb;
      color:#1f6feb;
    }
    .modal-reject:hover{ background:#f3f7ff; }

    /* âœ… ìŠ¹ì¸ ìŠ¤í”¼ë„ˆ: ìë¦¬ ìœ ì§€(ê°€ìš´ë° í”ë“¤ë¦¼ ë°©ì§€) */
    .btn-spinner{
      width:18px;
      height:18px;
      border-radius:50%;
      border:2px solid currentColor;
      border-right-color:transparent;
      animation:spin 0.8s linear infinite;

      position:absolute;           /* âœ… ì ˆëŒ€ ìœ„ì¹˜ */
      left:14px;                   /* âœ… ë²„íŠ¼ ì™¼ìª½ì— ê³ ì • */
      top:50%;
      transform:translateY(-50%);
      visibility:hidden;           /* ê¸°ë³¸ ìˆ¨ê¹€ */
    }
    .btn-spinner.is-on{ visibility:visible; }

    @keyframes spin{ to { transform:rotate(360deg); } }

    /* ëª¨ë°”ì¼ í„°ì¹˜ê° */
    @media (max-width:600px){
      .modal-action-btn{ height:64px; font-size:19px; }
    }
  </style>
</head>

<body>

  <!-- ===== ê²°ì¬ ëª¨ë‹¬ ===== -->
  <div id="apvModalBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:999; align-items:center; justify-content:center; padding:14px;">
    <div style="background:#fff; width:100%; max-width:420px; border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <div style="font-weight:800;">ê²°ì¬ ì²˜ë¦¬</div>
        <button type="button" id="apvModalClose" style="border:1px solid #999; background:#fff; border-radius:8px; padding:6px 10px; cursor:pointer;">ì·¨ì†Œ</button>
      </div>

      <div style="font-size:13px; color:#555; margin-bottom:10px;">
        ë¬¸ì„œ: <b>#{{ approval.id }}</b> Â· {{ approval.title }}
      </div>

      <!-- âœ… ë²„íŠ¼ ì˜ì—­: ê°€ìš´ë° ì •ë ¬ + ê°„ê²© ë„“ê²Œ -->
      <div style="display:flex; justify-content:center; gap:16px; margin-bottom:14px;">
        <form id="rejectForm" method="post" action="/approval/v2/{{ approval.id }}/reject/" style="flex:1; margin:0;">
          {% csrf_token %}
          <input type="hidden" name="reason" id="rejectReasonHidden">
          <button type="submit" id="rejectBtn" class="modal-action-btn modal-reject">
            âœ– ë°˜ë ¤
          </button>
        </form>

        <form id="approveForm" method="post" action="/approval/v2/{{ approval.id }}/approve/" style="flex:1; margin:0;">
          {% csrf_token %}
          <button type="submit" id="approveBtn" class="modal-action-btn modal-approve">
            <span class="btn-spinner" id="approveSpinner"></span>
            âœ” ìŠ¹ì¸
          </button>
        </form>
      </div>

      <!-- âœ… ê·¸ ì•„ë˜ ë°˜ë ¤ì‚¬ìœ  ì…ë ¥ì°½ -->
      <div style="margin-bottom:0;">
        <div style="font-size:13px; font-weight:700; margin-bottom:6px;">ë°˜ë ¤ ì‚¬ìœ (ë°˜ë ¤ ì‹œ í•„ìˆ˜)</div>
        <textarea id="rejectReasonInput" rows="3"
                  style="width:100%; box-sizing:border-box; border:1px solid #999; border-radius:10px; padding:10px; font-size:14px;"
                  placeholder="ë°˜ë ¤ ì‹œì—ë§Œ ì…ë ¥í•˜ì„¸ìš”."></textarea>
      </div>

    </div>
  </div>

  <div class="paper">
    <div class="header-wrapper">
      <div class="header-left">
        <div class="title-row"><h1>í’ˆ ì˜ ì„œ</h1></div>
        <div class="date-row">
          <span class="date-text">{{ approval.created_at|date:"Y-m-d H:i" }}</span>
        </div>
      </div>

      <!-- ===== ê²°ì¬ë€ ===== -->
      <table class="sign-table">
        <tr>
          {% for s in steps %}
            <th>
              {% if s.role == "drafter" %}ê¸°ì•ˆ{% elif s.role == "admin" %}ì´ë¬´{% elif s.role == "chairman" %}íšŒì¥{% elif s.role == "auditor" %}ê°ì‚¬{% else %}{{ s.role }}{% endif %}
            </th>
          {% endfor %}
        </tr>

        <tr>
          {% for s in steps %}
            <td class="stamp-td">
              <div class="stamp-cell">
                {% if s.state == "approved" %}

                  {% if s.stamp_image %}
                    <img src="{{ s.stamp_image.url }}" alt="stamp" class="stamp-img" />
                  {% else %}
                    <div class="stamp-svg-wrap" aria-label="approved stamp">
                      {% if route.template_code == "ADMIN_FINAL" and s.role == "admin" %}
                        <svg viewBox="0 0 120 120" class="stamp-svg" role="img" aria-label="ì „ê²°">
                          <rect x="10" y="10" width="100" height="100" fill="none" stroke="currentColor" stroke-width="6"/>
                          <text x="60" y="50" text-anchor="middle" font-size="22" font-weight="800" fill="currentColor">ì „ê²°</text>
                          <text x="60" y="80" text-anchor="middle" font-size="22" font-weight="800" fill="currentColor">ìŠ¹ì¸</text>
                        </svg>
                      {% else %}
                        <svg viewBox="0 0 120 120" class="stamp-svg" role="img" aria-label="ìŠ¹ì¸">
                          <rect x="10" y="10" width="100" height="100" fill="none" stroke="currentColor" stroke-width="6"/>
                          <text x="60" y="52" text-anchor="middle" font-size="22" font-weight="800" fill="currentColor">ìŠ¹ì¸</text>
                          <text x="60" y="82" text-anchor="middle" font-size="18" font-weight="800" fill="currentColor">
                            {% if s.role == "admin" %}ì´ë¬´{% elif s.role == "chairman" %}íšŒì¥{% elif s.role == "drafter" %}ê¸°ì•ˆ{% elif s.role == "auditor" %}ê°ì‚¬{% else %}{{ s.role }}{% endif %}
                          </text>
                        </svg>
                      {% endif %}
                    </div>
                  {% endif %}

                {% elif s.state == "rejected" %}
                  <img src="/static/img/reject_img.jpg" alt="ë°˜ë ¤" class="stamp-img" />

                {% elif route.status == "in_progress" and s.state == "pending" and s.role == actor_role %}
                  <button type="button" class="stamp-click" data-open-approval-modal="1">ê²° ì¬</button>

                {% else %}
                  <div class="stamp-empty"></div>
                {% endif %}
              </div>
            </td>
          {% endfor %}
        </tr>

        <tr class="sign-time-row">
          {% for s in steps %}
            <td>
              {% if s.acted_at %}
                {% load tz %}
                {{ s.acted_at|localtime|date:"n/j H:i" }}
              {% else %}
                &nbsp;
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      </table>
    </div>

    <table class="info-table">
      <tr>
        <th>ì†Œì†</th><td>{{ approval.department }}</td>
        <th>ì„±ëª…</th><td>{{ approval.name }}</td>
      </tr>
    </table>

    <table class="subject-table">
      <tr><th>ì œëª©</th><td>{{ approval.title }}</td></tr>
    </table>

    <table class="content-table">
      <tr>
        <th>ë‚´ìš©</th>
        <td><div class="content-value">{{ approval.content|safe }}</div></td>
      </tr>
    </table>

    {% for s in steps %}
      {% if s.state == "rejected" and s.reject_reason %}
        <div class="reject-box">
          <div class="t">
            ë°˜ë ¤ ì‚¬ìœ  (
            {% if s.role == "drafter" %}ê¸°ì•ˆ{% elif s.role == "admin" %}ì´ë¬´{% elif s.role == "chairman" %}íšŒì¥{% elif s.role == "auditor" %}ê°ì‚¬{% else %}{{ s.role }}{% endif %}
            )
          </div>
          <div class="c">{{ s.reject_reason }}</div>
        </div>
      {% endif %}
    {% endfor %}

    <!-- ì²¨ë¶€íŒŒì¼ -->
    {% if approval.v2_attachments.all %}
      <div class="attach-box">
        <div class="attach-title">ğŸ“ ì²¨ë¶€íŒŒì¼</div>
        <ul class="attach-list">
          {% for f in approval.v2_attachments.all %}
            <li>
              <a href="{{ f.file.url }}" target="_blank" rel="noopener">
                {{ f.original_name|default:f.file.name }}
              </a>
              <span class="attach-meta">
                {{ f.uploaded_at|date:"Y-m-d H:i" }}
              </span>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if route.status == "completed" %}
      <div class="done-row">
        <div class="done-msg-left">âœ… ê²°ì¬ê°€ ìµœì¢… ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>
        <div class="done-msg-right">
          <div>ì™„ë£Œ ì‹œê°: {{ route.completed_at|date:"Y-m-d H:i"|default:"-" }}</div>
          <div class="log-toggle" onclick="toggleLogs()">ğŸ” ìŠ¹ì¸ì ë¡œê·¸ ë³´ê¸°</div>
          <div id="logBox" class="log-box" style="display:none;">
            <div><b>ìƒì‹  IP</b>: {{ approval.submit_ip|default:"-" }}</div>
            {% for s in steps %}
              {% if s.acted_at %}
                <div class="log-line">
                  <b>
                    {% if s.role == "drafter" %}ë‹´ë‹¹
                    {% elif s.role == "admin" %}ì´ë¬´
                    {% elif s.role == "chairman" %}íšŒì¥
                    {% elif s.role == "auditor" %}ê°ì‚¬
                    {% else %}{{ s.role }}{% endif %}
                  </b>
                  Â· IP {{ s.acted_ip|default:"-" }}
                  Â· ê¸°ê¸° {{ s.acted_device|default:"-" }}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    {% elif route.status == "rejected" %}
      <p class="hint">ğŸš« ë°˜ë ¤ëœ ë¬¸ì„œì…ë‹ˆë‹¤. (ìƒì‹  í›„ ê²°ì¬ì„  ìˆ˜ì • ë¶ˆê°€ / ì¬ìƒì‹ ì€ ìƒˆë¡œ ì‘ì„±)</p>
    {% else %}
      <p class="hint">âœ… í˜„ì¬ ê²°ì¬ìê°€ ìŠ¹ì¸/ë°˜ë ¤ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    {% endif %}

    <div class="btn-row" style="margin-top:18px;">
      <a class="btn-link" href="/approval/v2/">ë¦¬ìŠ¤íŠ¸ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
  </div>

  <script>
  (function(){
    const backdrop = document.getElementById("apvModalBackdrop");
    const closeBtn = document.getElementById("apvModalClose");

    const reasonInput  = document.getElementById("rejectReasonInput");
    const reasonHidden = document.getElementById("rejectReasonHidden");

    const rejectForm = document.getElementById("rejectForm");
    const rejectBtn  = document.getElementById("rejectBtn");

    const approveForm    = document.getElementById("approveForm");
    const approveBtn     = document.getElementById("approveBtn");
    const approveSpinner = document.getElementById("approveSpinner");

    function openModal(){
      if(!backdrop) return;
      if(reasonInput) reasonInput.value = "";
      if(reasonHidden) reasonHidden.value = "";
      if(rejectBtn) rejectBtn.disabled = false;
      if(approveBtn) approveBtn.disabled = false;
      if(approveSpinner) approveSpinner.classList.remove("is-on");

      backdrop.style.display = "flex";

      // âœ… ëª¨ë‹¬ ì˜¤í”ˆ ì‹œ ë²„íŠ¼ ìª½ìœ¼ë¡œ í¬ì»¤ìŠ¤
      if(rejectBtn) rejectBtn.focus();
      else if(approveBtn) approveBtn.focus();
    }

    function closeModal(){
      if(!backdrop) return;
      backdrop.style.display = "none";
    }

    document.querySelectorAll("[data-open-approval-modal]").forEach(el=>{
      el.addEventListener("click", openModal);
    });

    if(closeBtn) closeBtn.addEventListener("click", closeModal);

    if(backdrop){
      backdrop.addEventListener("click", (e)=>{
        if(e.target === backdrop) closeModal();
      });
    }

    // âœ… ë°˜ë ¤: ì‚¬ìœ  ì—†ìœ¼ë©´ ë§‰ê³ , ì‚¬ìœ  ìˆì„ ë•Œë§Œ disable
    if(rejectForm){
      rejectForm.addEventListener("submit", (e)=>{
        const v = (reasonInput?.value || "").trim();
        if(!v){
          e.preventDefault();
          alert("ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          if(reasonInput) reasonInput.focus();
          if(rejectBtn) rejectBtn.disabled = false; // í˜¹ì‹œë¼ë„ ì ê²¼ë‹¤ë©´ ë³µêµ¬
          return;
        }
        if(reasonHidden) reasonHidden.value = v;
        if(rejectBtn) rejectBtn.disabled = true; // âœ… í†µê³¼í–ˆì„ ë•Œë§Œ ì ê¸ˆ
      });
    }

    // âœ… ìŠ¹ì¸: ìŠ¤í”¼ë„ˆ + ë²„íŠ¼ ì ê¸ˆ(ì¤‘ë³µ ì œì¶œ ë°©ì§€)
    if(approveForm && approveBtn && approveSpinner){
      approveForm.addEventListener("submit", ()=>{
        approveBtn.disabled = true;
        approveSpinner.classList.add("is-on");
      });
    }
  })();

  function toggleLogs(){
    const el = document.getElementById("logBox");
    if(!el) return;
    el.style.display = (el.style.display === "none") ? "block" : "none";
  }
  </script>
</body>
</html>
