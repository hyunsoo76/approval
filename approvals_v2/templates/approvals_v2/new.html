{% extends "base.html" %}

{% block title %}í’ˆì˜ì„œ ì‘ì„±(v2){% endblock %}

{% block extra_head %}
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"ë§‘ì€ ê³ ë”•",sans-serif;margin:20px;}
  .paper{width:100%;max-width:900px;border:1px solid #000;padding:20px;box-sizing:border-box;margin:0 auto;background:#fff;}

  .header-wrapper{display:flex;align-items:flex-start;justify-content:center;margin-bottom:10px;}
  .header-left{flex:1;text-align:center;}
  .title-row h1{margin:0;font-size:36px;letter-spacing:0.4em;}
  .date-row{margin:10px 0 20px 0;font-size:16px;}
  .date-row .date-text{display:inline-block;min-width:160px;padding-bottom:2px;border-bottom:1px solid #000;font-size:14px;color:#444;}

  .sign-table{margin-left:auto;border-collapse:collapse;border:1px solid #000;font-size:14px;background:#fff;}
  .sign-table th,.sign-table td{border:1px solid #000;width:80px;height:40px;text-align:center;vertical-align:middle;}
  .sign-box{width:80px;height:80px;position:relative;}
  .sign-box-inner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px;color:#666;text-align:center;}

  .info-table,.subject-table,.content-table{width:100%;border-collapse:collapse;table-layout:fixed;margin-bottom:10px;}
  .info-table th,.info-table td,.subject-table th,.subject-table td,.content-table th,.content-table td{border:1px solid #000;padding:6px;font-size:14px;}
  .info-table th,.subject-table th,.content-table th{width:80px;text-align:center;background-color:#f8f8f8;}
  .content-table td{height:420px;vertical-align:top;}

  input[type="text"], select, textarea{
    width:100%; box-sizing:border-box;
    border:none; outline:none;
    font-size:14px; background:transparent;
  }
  textarea{height:100%; resize:none; white-space:pre-wrap; word-break:break-word;}

  .btn-row{margin-top:18px;text-align:center;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
  .btn{padding:10px 18px;font-size:14px;cursor:pointer;border:1px solid #555;border-radius:6px;background:#eee;}
  .btn.primary{background:#1f6feb;color:#fff;border-color:#1f6feb;}
  .hint{font-size:13px;color:#444;margin-top:10px;}

  @media (max-width:600px){
    body{margin:10px;font-size:13px;}
    .paper{padding:10px;}
    .header-wrapper{flex-direction:column;align-items:stretch;}
    .header-left{margin-bottom:10px;}
    .title-row h1{font-size:28px;letter-spacing:0.25em;}
    .date-row{margin:8px 0 12px 0;font-size:14px;}
    .sign-table{align-self:flex-end;}
    .sign-table th,.sign-table td{width:70px;height:36px;font-size:12px;}
    .sign-box{width:70px;height:70px;}
    .sign-box-inner{font-size:11px;}
    .info-table th,.subject-table th,.content-table th{width:70px;}
    .content-table td{height:280px;}
  }

  /* ì—ë””í„° ì•ˆ ì´ë¯¸ì§€ ê¸°ë³¸ */
  #contentEditor img{
    max-width: 100%;
    height: auto;
  }

  /* ì„ íƒëœ ì´ë¯¸ì§€ í‘œì‹œ */
  #contentEditor img.img-selected{
    outline: 2px solid rgba(13,110,253,.6);
    outline-offset: 2px;
  }

  /* ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ */
  .img-resize-handle{
    position: absolute;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(13,110,253,.9);
    background: #fff;
    border-radius: 3px;
    cursor: nwse-resize;
    box-shadow: 0 1px 4px rgba(0,0,0,.2);
    z-index: 9999;
  }

  /* ì´ë¯¸ì§€ í€µ ë²„íŠ¼ */
  .img-size-toolbar{
    position: absolute;
    display: flex;
    gap: 6px;
    padding: 6px;
    background: rgba(255,255,255,.95);
    border: 1px solid #ddd;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,.12);
    z-index: 9999;
  }
  .img-size-toolbar button{
    border: 1px solid #666;
    background: #fff;
    color: #222;
    padding: 3px 8px;
    border-radius: 8px;
    font-size: 12px;
    cursor: pointer;
  }
</style>
{% endblock %}

{% block content %}
<div class="paper">

  <form method="post" action="/approval/v2/new/" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="header-wrapper">
      <div class="header-left">
        <div class="title-row"><h1>í’ˆ ì˜ ì„œ</h1></div>
        <div class="date-row">
          <span class="date-text">ì‘ì„±ì¼: {{ now|default:"-" }}</span>
        </div>
      </div>

      <table class="sign-table" id="signTable">
        <tr id="signHead"></tr>
        <tr id="signBody"></tr>
      </table>
    </div>

    <table class="info-table">
      <tr>
        <th style="width:70px;">ê²°ì¬ì„ </th>
        <td colspan="3">
          <select name="template_code" id="template_code" required>
            <option value="">ì„ íƒ</option>
            <option value="ADMIN_FINAL">ì´ë¬´ì „ê²°(ë‹´ë‹¹â†’ì´ë¬´)</option>
            <option value="NORMAL">ì¼ë°˜í’ˆì˜(ë‹´ë‹¹â†’ì´ë¬´â†’íšŒì¥)</option>
            <option value="ADMIN_TO_CHAIR">ì´ë¬´í’ˆì˜(ì´ë¬´â†’íšŒì¥)</option>
            <option value="ADMIN_TO_AUDITOR_CHAIR">ì´ë¬´í’ˆì˜(ì´ë¬´â†’ê°ì‚¬â†’íšŒì¥)</option>
          </select>
        </td>
      </tr>

      <!-- âœ… ìë¦¬ ë³€ê²½: ì„±ëª… -> ì†Œì† -->
      <tr>
        <th>ì„±ëª…</th>
        <td>
          <select class="form-select" name="name" id="nameSelect" required>
            <option value="" selected disabled>ì„ íƒ (ì´ë¦„ ì—†ìœ¼ë©´ ë“±ë¡ìš”ì²­)</option>
          </select>
          <div id="nameHint" style="margin-top:4px; font-size:12px; color:#666; display:none;"></div>
        </td>

        <th>ì†Œì†</th>
        <td>
          <input type="text" name="department" id="deptInput"
                placeholder="ì„±ëª… ì„ íƒ ì‹œ ìë™ ì…ë ¥"
                readonly
                style="background:#f3f3f3; cursor:not-allowed;">
        </td>
      </tr>
    </table>

    <table class="subject-table">
      <tr>
        <th style="width:70px;">ì œëª©</th>
        <td><input type="text" name="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required></td>
      </tr>
    </table>

    <table class="content-table">
      <tr>
        <th style="width:70px;">ë‚´ìš©</th>
        <td>
          <div id="contentEditor"
               contenteditable="true"
               style="min-height:100%; padding:8px; outline:none; white-space:pre-wrap; word-break:break-word;">
          </div>
          <input type="hidden" name="content" id="contentHidden" required>
        </td>
      </tr>
    </table>

    <button type="button" class="btn" id="mobileUploadBtn">
        ğŸ“· íœ´ëŒ€í° ì´¬ì˜ ì—…ë¡œë“œ
      </button>
      <div id="qrBox" style="margin-top:10px;"></div>

    <table class="info-table" style="margin-top:-1px;">
      <tr>
        <th style="width:70px;">ì²¨ë¶€</th>
        <td colspan="3">
          <input type="file" id="attachmentsInput" name="attachments" multiple style="display:none;">
          <button type="button" class="btn" id="addFilesBtn">íŒŒì¼ ì¶”ê°€</button>
          <div id="fileList" style="margin-top:6px; font-size:13px; color:#333;"></div>
          <!-- <div style="font-size:12px; color:#666; margin-top:4px;">
            ì´ë¯¸ì§€ëŠ” ìœ„ ë‚´ìš©ë€ì— ìŠ¤í¬ë¦°ìƒ·ìœ¼ë¡œ ë¶™ì—¬ë„£ê¸° í•˜ë©´ ê²°ì¬ìê°€ ë°”ë¡œ í™•ì¸ ê°€ëŠ¥
          </div> -->
        </td>
      </tr>
    </table>

    <div class="hint">
      âœ… ì´ë¯¸ì§€ëŠ” ìœ„ ë‚´ìš©ë€ì— ìŠ¤í¬ë¦°ìƒ·ìœ¼ë¡œ ë¶™ì—¬ë„£ê¸° í•˜ë©´ ê²°ì¬ìê°€ ë°”ë¡œ í™•ì¸ ê°€ëŠ¥.
    </div>

    <div class="btn-row">
      <button class="btn primary" type="submit">ìƒì‹ </button>
      <a class="btn" href="/approval/v2/">ë¦¬ìŠ¤íŠ¸</a>
    </div>
  </form>

</div>

{{ drafters|json_script:"drafters-data" }}
{{ admins|json_script:"admins-data" }}
{% endblock %}

{% block extra_script %}
<script>
  const tpl  = document.getElementById("template_code");
  const head = document.getElementById("signHead");
  const body = document.getElementById("signBody");

  function renderSign(cols){
    head.innerHTML = "";
    body.innerHTML = "";
    cols.forEach(c=>{
      const th = document.createElement("th");
      th.textContent = c;
      head.appendChild(th);

      const td = document.createElement("td");
      td.innerHTML = '<div class="sign-box"><div class="sign-box-inner">ìƒì‹  í›„ ì²˜ë¦¬</div></div>';
      body.appendChild(td);
    });
  }

  function onTpl(){
    const v = tpl.value;

    if(v === "ADMIN_FINAL") renderSign(["ê¸°ì•ˆ","ì´ë¬´"]);
    else if(v === "NORMAL") renderSign(["ê¸°ì•ˆ","ì´ë¬´","íšŒì¥"]);
    else if(v === "ADMIN_TO_CHAIR") renderSign(["ì´ë¬´","íšŒì¥"]);
    else if(v === "ADMIN_TO_AUDITOR_CHAIR") renderSign(["ì´ë¬´","ê°ì‚¬","íšŒì¥"]);
    else renderSign(["-"]);

    syncNameOptions();
  }
  tpl.addEventListener("change", onTpl);

  const DRAFTERS = JSON.parse(document.getElementById("drafters-data").textContent || "[]");
  const ADMINS   = JSON.parse(document.getElementById("admins-data").textContent || "[]");

  const ADMIN_NAME = "{{ admin_name|default:'' }}";

  const nameSelect = document.getElementById("nameSelect");
  const nameHint   = document.getElementById("nameHint");
  const deptInput  = document.getElementById("deptInput");

  const DEFAULT_ADMIN_DEPT = "(ì£¼)ìƒˆì§„";

  function setNameOptions(list, autoSelectName){
    nameSelect.innerHTML = "";

    const ph = document.createElement("option");
    ph.value = "";
    ph.disabled = true;
    ph.selected = true;
    ph.textContent = "ì„ íƒ (ì´ë¦„ ì—†ìœ¼ë©´ ë“±ë¡ìš”ì²­)";
    nameSelect.appendChild(ph);

    list.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u.name;
      opt.textContent = u.name;
      // âœ… viewsì—ì„œ department ë‚´ë ¤ì£¼ë©´ ì—¬ê¸°ë¡œ ë“¤ì–´ì˜´
      opt.dataset.dept = (u.department || "");
      nameSelect.appendChild(opt);
    });

    if (autoSelectName) {
      for (const opt of nameSelect.options) {
        if (opt.value === autoSelectName) {
          opt.selected = true;
          break;
        }
      }
    }
  }

  function syncDeptBySelectedName(){
    if (!deptInput || !nameSelect) return;

    const opt = nameSelect.options[nameSelect.selectedIndex];
    const dept = (opt && opt.dataset) ? (opt.dataset.dept || "") : "";

    // âœ… ê°’ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ, ì—†ìœ¼ë©´ ë¹ˆì¹¸
    deptInput.value = dept;
  }

  if (nameSelect) {
    nameSelect.addEventListener("change", syncDeptBySelectedName);
  }

  function syncNameOptions(){
    const v = tpl.value;

    // ì´ë¬´ ì‹œì‘ í…œí”Œë¦¿: ì´ë¬´ë§Œ ë…¸ì¶œ + ìë™ ì„ íƒ
    if (v === "ADMIN_TO_CHAIR" || v === "ADMIN_TO_AUDITOR_CHAIR") {
      setNameOptions(ADMINS, ADMIN_NAME || (ADMINS[0] ? ADMINS[0].name : ""));
      if (nameHint) nameHint.style.display = "block";

      // âœ… ìë™ì„ íƒëœ ì´ë¬´ ê¸°ì¤€ìœ¼ë¡œ dept ì±„ìš°ê¸°
      syncDeptBySelectedName();

      // âœ… ê·¸ë˜ë„ deptê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’
      if (deptInput && !deptInput.value.trim()) {
        deptInput.value = DEFAULT_ADMIN_DEPT;
      }
      return;
    }

    // ë‹´ë‹¹ ì‹œì‘ í…œí”Œë¦¿: ë‹´ë‹¹ë§Œ ë…¸ì¶œ
    if (v === "ADMIN_FINAL" || v === "NORMAL") {
      setNameOptions(DRAFTERS, "");
      if (nameHint){
        nameHint.style.display = "none";
        nameHint.textContent = "";
      }

      // âœ… ë‹´ë‹¹ ì„ íƒ ì „ì´ë¯€ë¡œ ì†Œì†ì€ ë¹„ì›€
      if (deptInput) deptInput.value = "";
      return;
    }

    // ê²°ì¬ì„  ì„ íƒ ì „(ê¸°ë³¸)
    setNameOptions(DRAFTERS, "");
    if (nameHint){
      nameHint.style.display = "none";
      nameHint.textContent = "";
    }
    if (deptInput) deptInput.value = "";
  }

  // ì´ˆê¸° ë Œë”
  onTpl();

  // contenteditable -> hidden
  const form   = document.querySelector('form[action="/approval/v2/new/"]');
  const editor = document.getElementById("contentEditor");
  const hidden = document.getElementById("contentHidden");

  if (form && editor && hidden) {
    form.addEventListener("submit", () => {
      hidden.value = editor.innerHTML.trim();
    });

    editor.addEventListener("paste", async (e) => {
      const items = (e.clipboardData || window.clipboardData)?.items || [];
      for (const item of items) {
        if (item.type && item.type.startsWith("image/")) {
          e.preventDefault();
          const file = item.getAsFile();
          if (!file) return;

          const dataUrl = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
          });

          const img = document.createElement("img");
          img.src = dataUrl;
          img.style.maxWidth = "100%";
          img.style.height = "auto";
          img.style.display = "block";
          img.style.margin = "6px 0";

          const sel = window.getSelection();
          if (sel && sel.rangeCount) {
            const range = sel.getRangeAt(0);
            range.deleteContents();
            range.insertNode(img);
            range.setStartAfter(img);
            range.setEndAfter(img);
            sel.removeAllRanges();
            sel.addRange(range);
          } else {
            editor.appendChild(img);
          }
          return;
        }
      }
    });
  }

  // ì²¨ë¶€ ëˆ„ì 
  const attachmentsInput = document.getElementById("attachmentsInput");
  const addFilesBtn = document.getElementById("addFilesBtn");
  const fileList = document.getElementById("fileList");

  let selectedFiles = [];

  function renderFileList(){
    if (!fileList) return;
    if (selectedFiles.length === 0) {
      fileList.textContent = "ì„ íƒëœ íŒŒì¼ ì—†ìŒ";
      return;
    }
    fileList.innerHTML = selectedFiles
      .map((f, idx) => `<div>${idx+1}. ${f.name} <span style="color:#888;">(${Math.round(f.size/1024)} KB)</span></div>`)
      .join("");
  }

  function syncInputFiles(){
    const dt = new DataTransfer();
    selectedFiles.forEach(f => dt.items.add(f));
    attachmentsInput.files = dt.files;
  }

  if (addFilesBtn && attachmentsInput) {
    addFilesBtn.addEventListener("click", () => attachmentsInput.click());
    attachmentsInput.addEventListener("change", () => {
      const files = Array.from(attachmentsInput.files || []);
      selectedFiles = selectedFiles.concat(files);
      syncInputFiles();
      renderFileList();
    });
    renderFileList();
  }

    // ====== ëª¨ë°”ì¼ ì—…ë¡œë“œ QR + í´ë§ (ì•ˆì „ë²„ì „) ======
  (function(){
    const btn = document.getElementById("mobileUploadBtn");
    const qrBox = document.getElementById("qrBox");
    const editor = document.getElementById("contentEditor");

    if(!btn || !qrBox || !editor){
      console.error("mobile upload dom missing", {btn, qrBox, editor});
      return;
    }

    // âœ… randomUUID ì•ˆì „í•˜ê²Œ (ì—†ìœ¼ë©´ fallback)
    function makeToken(){
      try{
        if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
      }catch(e){}
      return "tok-" + Date.now() + "-" + Math.random().toString(16).slice(2);
    }

    const uploadToken = makeToken();
    let lastImageUrl = ""; // âœ… ì¤‘ë³µì‚½ì… ë°©ì§€

    btn.addEventListener("click", () => {
      const url = window.location.origin + "/approval/v2/mobile-upload/" + uploadToken + "/";

      const qrImgUrl =
        "https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=" +
        encodeURIComponent(url);

      qrBox.innerHTML = `
        <div style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">
          <img src="${qrImgUrl}" alt="QR" style="width:180px; height:180px; border:1px solid #ddd; background:#fff;">
          <div style="font-size:12px; color:#333; max-width:360px; word-break:break-all;">
            <div style="font-weight:700; margin-bottom:6px;">íœ´ëŒ€í°ìœ¼ë¡œ QRì„ ì°ì–´ ì—…ë¡œë“œ</div>
            <div style="margin-bottom:6px;">URL:</div>
            <div style="padding:8px; border:1px dashed #bbb; border-radius:8px; background:#fafafa;">${url}</div>
            <div style="margin-top:8px; color:#666;">â€» ê°™ì€ Wi-Fiì—ì„œ ì ‘ì†ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</div>
          </div>
        </div>
      `;
    });

    setInterval(() => {
      fetch(`/approval/v2/mobile-upload/${uploadToken}/poll/`, { cache: "no-store" })
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          if(!data || !data.image_url) return;

          if(data.image_url === lastImageUrl) return;
          lastImageUrl = data.image_url;

          const img = document.createElement("img");
          img.src = data.image_url;
          img.style.maxWidth = "100%";
          img.style.height = "auto";
          img.style.display = "block";
          img.style.margin = "6px 0";
          editor.appendChild(img);
        })
        .catch(() => {});
    }, 3000);
  })();

  (function(){
  const editor = document.getElementById('contentEditor');
  if (!editor) return;

  let selectedImg = null;
  let handleEl = null;
  let toolbarEl = null;

  let dragging = false;
  let startX = 0;
  let startW = 0;

  function removeUI(){
    if (handleEl) { handleEl.remove(); handleEl = null; }
    if (toolbarEl) { toolbarEl.remove(); toolbarEl = null; }
    if (selectedImg) { selectedImg.classList.remove('img-selected'); }
    selectedImg = null;
  }

  function placeHandleAndToolbar(img){
    // í•¸ë“¤
    const rect = img.getBoundingClientRect();
    const pageX = window.scrollX;
    const pageY = window.scrollY;

    handleEl = document.createElement('div');
    handleEl.className = 'img-resize-handle';
    document.body.appendChild(handleEl);

    // íˆ´ë°”(50/75/100)
    toolbarEl = document.createElement('div');
    toolbarEl.className = 'img-size-toolbar';
    toolbarEl.innerHTML = `
      <button type="button" data-pct="50">50%</button>
      <button type="button" data-pct="75">75%</button>
      <button type="button" data-pct="100">100%</button>
    `;
    document.body.appendChild(toolbarEl);

    function reposition(){
      const r = img.getBoundingClientRect();
      const x = window.scrollX;
      const y = window.scrollY;

      // í•¸ë“¤: ì˜¤ë¥¸ìª½ ì•„ë˜
      handleEl.style.left = (x + r.right - 8) + 'px';
      handleEl.style.top  = (y + r.bottom - 8) + 'px';

      // íˆ´ë°”: ì´ë¯¸ì§€ ìœ„ìª½ ì˜¤ë¥¸ìª½
      toolbarEl.style.left = (x + r.right - 170) + 'px';
      toolbarEl.style.top  = (y + r.top - 44) + 'px';
    }

    reposition();

    // ìŠ¤í¬ë¡¤/ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ë”°ë¼ê°€ê¸°
    const onWin = () => { if (selectedImg === img) reposition(); };
    window.addEventListener('scroll', onWin, { passive:true });
    window.addEventListener('resize', onWin);

    // íˆ´ë°” ë²„íŠ¼
    toolbarEl.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-pct]');
      if (!btn) return;
      const pct = parseInt(btn.dataset.pct, 10);
      // ì—ë””í„° í­ ê¸°ì¤€ í¼ì„¼íŠ¸
      img.style.width = pct + '%';
      img.style.height = 'auto';
      reposition();
    });

    // ë“œë˜ê·¸ ë¦¬ì‚¬ì´ì¦ˆ
    function startDrag(ev){
      ev.preventDefault();
      dragging = true;
      startX = ev.clientX;
      startW = img.getBoundingClientRect().width;
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', endDrag);
    }

    function onMove(ev){
      if (!dragging) return;
      const dx = ev.clientX - startX;
      const newW = Math.max(60, startW + dx); // ìµœì†Œ í­ 60px
      img.style.width = newW + 'px';
      img.style.height = 'auto';
      reposition();
    }

    function endDrag(){
      dragging = false;
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', endDrag);
    }

    handleEl.addEventListener('mousedown', startDrag);
  }

  // ì—ë””í„° ë‚´ ì´ë¯¸ì§€ í´ë¦­í•˜ë©´ ì„ íƒ
  editor.addEventListener('click', (e) => {
    const img = e.target && e.target.tagName === 'IMG' ? e.target : null;
    if (!img) return;

    removeUI();
    selectedImg = img;
    selectedImg.classList.add('img-selected');
    placeHandleAndToolbar(selectedImg);
  });

  // ì—ë””í„° ë°– í´ë¦­í•˜ë©´ í•´ì œ
  document.addEventListener('click', (e) => {
    if (!selectedImg) return;
    const inEditor = editor.contains(e.target);
    const inUI = (handleEl && handleEl.contains(e.target)) || (toolbarEl && toolbarEl.contains(e.target));
    if (!inEditor && !inUI) removeUI();
  });

})();



</script>
{% endblock %}
