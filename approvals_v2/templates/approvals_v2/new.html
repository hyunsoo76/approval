{% extends "base.html" %}

{% block title %}품의서 작성(v2){% endblock %}

{% block extra_head %}
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"맑은 고딕",sans-serif;margin:20px;}
  .paper{width:100%;max-width:900px;border:1px solid #000;padding:20px;box-sizing:border-box;margin:0 auto;background:#fff;}

  .header-wrapper{display:flex;align-items:flex-start;justify-content:center;margin-bottom:10px;}
  .header-left{flex:1;text-align:center;}
  .title-row h1{margin:0;font-size:36px;letter-spacing:0.4em;}
  .date-row{margin:10px 0 20px 0;font-size:16px;}
  .date-row .date-text{display:inline-block;min-width:160px;padding-bottom:2px;border-bottom:1px solid #000;font-size:14px;color:#444;}

  .sign-table{margin-left:auto;border-collapse:collapse;border:1px solid #000;font-size:14px;background:#fff;}
  .sign-table th,.sign-table td{border:1px solid #000;width:80px;height:40px;text-align:center;vertical-align:middle;}
  .sign-box{width:80px;height:80px;position:relative;}
  .sign-box-inner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px;color:#666;text-align:center;}

  .info-table,.subject-table,.content-table{width:100%;border-collapse:collapse;table-layout:fixed;margin-bottom:10px;}
  .info-table th,.info-table td,.subject-table th,.subject-table td,.content-table th,.content-table td{border:1px solid #000;padding:6px;font-size:14px;}
  .info-table th,.subject-table th,.content-table th{width:80px;text-align:center;background-color:#f8f8f8;}
  .content-table td{height:420px;vertical-align:top;}

  input[type="text"], select, textarea{
    width:100%; box-sizing:border-box;
    border:none; outline:none;
    font-size:14px; background:transparent;
  }
  textarea{height:100%; resize:none; white-space:pre-wrap; word-break:break-word;}

  .btn-row{margin-top:18px;text-align:center;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
  .btn{padding:10px 18px;font-size:14px;cursor:pointer;border:1px solid #555;border-radius:6px;background:#eee;}
  .btn.primary{background:#1f6feb;color:#fff;border-color:#1f6feb;}
  .hint{font-size:13px;color:#444;margin-top:10px;}

  @media (max-width:600px){
    body{margin:10px;font-size:13px;}
    .paper{padding:10px;}
    .header-wrapper{flex-direction:column;align-items:stretch;}
    .header-left{margin-bottom:10px;}
    .title-row h1{font-size:28px;letter-spacing:0.25em;}
    .date-row{margin:8px 0 12px 0;font-size:14px;}
    .sign-table{align-self:flex-end;}
    .sign-table th,.sign-table td{width:70px;height:36px;font-size:12px;}
    .sign-box{width:70px;height:70px;}
    .sign-box-inner{font-size:11px;}
    .info-table th,.subject-table th,.content-table th{width:70px;}
    .content-table td{height:280px;}
  }
</style>
{% endblock %}

{% block content %}
<div class="paper">

  <form method="post" action="/approval/v2/new/" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="header-wrapper">
      <div class="header-left">
        <div class="title-row"><h1>품 의 서</h1></div>
        <div class="date-row">
          <span class="date-text">작성일: {{ now|default:"-" }}</span>
        </div>
      </div>

      <table class="sign-table" id="signTable">
        <tr id="signHead"></tr>
        <tr id="signBody"></tr>
      </table>
    </div>

    <table class="info-table">
      <tr>
        <th style="width:80px;">결재선</th>
        <td colspan="3">
          <select name="template_code" id="template_code" required>
            <option value="">선택</option>
            <option value="ADMIN_FINAL">총무전결(담당→총무)</option>
            <option value="NORMAL">일반품의(담당→총무→회장)</option>
            <option value="ADMIN_TO_CHAIR">총무품의(총무→회장)</option>
          </select>
        </td>
      </tr>
      <tr>
        <th>소속</th>
        <td><input type="text" name="department" id="deptInput" placeholder="예: (주)대진산업" required></td>
        <th>성명</th>
        <td>
          <select class="form-select" name="name" id="nameSelect" required>
            <option value="" selected disabled>선택 (이름 없으면 등록요청)</option>
          </select>
          <div id="nameHint" style="margin-top:4px; font-size:12px; color:#666; display:none;"></div>
        </td>
      </tr>
    </table>

    <table class="subject-table">
      <tr>
        <th>제목</th>
        <td><input type="text" name="title" placeholder="제목을 입력하세요" required></td>
      </tr>
    </table>

    <table class="content-table">
      <tr>
        <th>내용</th>
        <td>
          <div id="contentEditor"
               contenteditable="true"
               style="min-height:100%; padding:8px; outline:none; white-space:pre-wrap; word-break:break-word;">
          </div>
          <input type="hidden" name="content" id="contentHidden" required>
        </td>
      </tr>
    </table>

    <table class="info-table" style="margin-top:-1px;">
      <tr>
        <th style="width:80px;">첨부</th>
        <td colspan="3">
          <input type="file" id="attachmentsInput" name="attachments" multiple style="display:none;">
          <button type="button" class="btn" id="addFilesBtn">파일 추가</button>
          <div id="fileList" style="margin-top:6px; font-size:13px; color:#333;"></div>
          <div style="font-size:12px; color:#666; margin-top:4px;">
            여러 파일을 추가하려면 “파일 추가”를 여러 번 눌러도 됩니다.
          </div>
        </td>
      </tr>
    </table>

    <div class="hint">
      ✅ 내용 작성란에 이미지 붙여넣기 가능, 상신하면 바로 상세 화면으로 이동합니다.
    </div>

    <div class="btn-row">
      <button class="btn primary" type="submit">상신</button>
      <a class="btn" href="/approval/v2/">리스트</a>
    </div>
  </form>

</div>

{{ drafters|json_script:"drafters-data" }}
{{ admins|json_script:"admins-data" }}
{% endblock %}

{% block extra_script %}
<script>
  const tpl  = document.getElementById("template_code");
  const head = document.getElementById("signHead");
  const body = document.getElementById("signBody");

  function renderSign(cols){
    head.innerHTML = "";
    body.innerHTML = "";
    cols.forEach(c=>{
      const th = document.createElement("th");
      th.textContent = c;
      head.appendChild(th);

      const td = document.createElement("td");
      td.innerHTML = '<div class="sign-box"><div class="sign-box-inner">상신 후 처리</div></div>';
      body.appendChild(td);
    });
  }

  function onTpl(){
    const v = tpl.value;
    if(v === "ADMIN_FINAL") renderSign(["기안","총무"]);
    else if(v === "NORMAL") renderSign(["기안","총무","회장"]);
    else if(v === "ADMIN_TO_CHAIR") renderSign(["총무","회장"]);
    else renderSign(["-"]);
    syncNameOptions();
  }
  tpl.addEventListener("change", onTpl);

  const DRAFTERS = JSON.parse(document.getElementById("drafters-data").textContent);
  const ADMINS   = JSON.parse(document.getElementById("admins-data").textContent);

  const ADMIN_NAME = "{{ admin_name|default:'' }}";

  const nameSelect = document.getElementById("nameSelect");
  const nameHint   = document.getElementById("nameHint");

  function setNameOptions(list, autoSelectName){
    nameSelect.innerHTML = "";

    const ph = document.createElement("option");
    ph.value = "";
    ph.disabled = true;
    ph.selected = true;
    ph.textContent = "선택 (이름 없으면 등록요청)";
    nameSelect.appendChild(ph);

    list.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u.name;
      opt.textContent = u.name;
      nameSelect.appendChild(opt);
    });

    if (autoSelectName) {
      for (const opt of nameSelect.options) {
        if (opt.value === autoSelectName) {
          opt.selected = true;
          break;
        }
      }
    }
  }

  const deptInput = document.getElementById("deptInput");
  const DEFAULT_ADMIN_DEPT = "(주)새진";

  function syncNameOptions(){
    const v = tpl.value;

    if (v === "ADMIN_TO_CHAIR") {
      setNameOptions(ADMINS, ADMIN_NAME || (ADMINS[0] ? ADMINS[0].name : ""));
      nameHint.style.display = "block";

      if (deptInput && !deptInput.value.trim()) {
        deptInput.value = DEFAULT_ADMIN_DEPT;
      }
    } else if (v === "ADMIN_FINAL" || v === "NORMAL") {
      setNameOptions(DRAFTERS, "");
      nameHint.style.display = "none";
      nameHint.textContent = "";
    } else {
      setNameOptions(DRAFTERS, "");
      nameHint.style.display = "none";
      nameHint.textContent = "";
    }
  }

  onTpl();

  // contenteditable -> hidden
  const form   = document.querySelector('form[action="/approval/v2/new/"]');
  const editor = document.getElementById("contentEditor");
  const hidden = document.getElementById("contentHidden");

  if (form && editor && hidden) {
    form.addEventListener("submit", () => {
      hidden.value = editor.innerHTML.trim();
    });

    editor.addEventListener("paste", async (e) => {
      const items = (e.clipboardData || window.clipboardData)?.items || [];
      for (const item of items) {
        if (item.type && item.type.startsWith("image/")) {
          e.preventDefault();
          const file = item.getAsFile();
          if (!file) return;

          const dataUrl = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
          });

          const img = document.createElement("img");
          img.src = dataUrl;
          img.style.maxWidth = "100%";
          img.style.height = "auto";
          img.style.display = "block";
          img.style.margin = "6px 0";

          const sel = window.getSelection();
          if (sel && sel.rangeCount) {
            const range = sel.getRangeAt(0);
            range.deleteContents();
            range.insertNode(img);
            range.setStartAfter(img);
            range.setEndAfter(img);
            sel.removeAllRanges();
            sel.addRange(range);
          } else {
            editor.appendChild(img);
          }
          return;
        }
      }
    });
  }

  // 첨부 누적
  const attachmentsInput = document.getElementById("attachmentsInput");
  const addFilesBtn = document.getElementById("addFilesBtn");
  const fileList = document.getElementById("fileList");

  let selectedFiles = [];

  function renderFileList(){
    if (!fileList) return;
    if (selectedFiles.length === 0) {
      fileList.textContent = "선택된 파일 없음";
      return;
    }
    fileList.innerHTML = selectedFiles
      .map((f, idx) => `<div>${idx+1}. ${f.name} <span style="color:#888;">(${Math.round(f.size/1024)} KB)</span></div>`)
      .join("");
  }

  function syncInputFiles(){
    const dt = new DataTransfer();
    selectedFiles.forEach(f => dt.items.add(f));
    attachmentsInput.files = dt.files;
  }

  if (addFilesBtn && attachmentsInput) {
    addFilesBtn.addEventListener("click", () => attachmentsInput.click());
    attachmentsInput.addEventListener("change", () => {
      const files = Array.from(attachmentsInput.files || []);
      selectedFiles = selectedFiles.concat(files);
      syncInputFiles();
      renderFileList();
    });
    renderFileList();
  }
</script>
{% endblock %}
