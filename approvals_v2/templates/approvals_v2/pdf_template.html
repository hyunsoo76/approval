{% load static %}
{% load tz %}
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>í’ˆì˜ì„œ #{{ approval.id }} - {{ approval.title }}</title>
  <style>
    /* ===== í˜ì´ì§€ ê¸°ë³¸ ===== */
    @page {
      size: A4;
      margin: 14mm 12mm;

      @bottom-right {
        content: "Page " counter(page) " / " counter(pages);
        font-size: 10px;
        color: #666;
      }
      @bottom-left {
        content: "ë‚´ì‡¼ë‚ ìƒˆì²œë…„ ì „ìê²°ì¬";
        font-size: 10px;
        color: #666;
      }
    }

    * { box-sizing: border-box; }
    body{
      font-family: "Noto Sans CJK KR","Noto Serif CJK KR","NanumGothic","Apple SD Gothic Neo","ë§‘ì€ ê³ ë”•",sans-serif;
      font-size: 12px;
      color: #111;
      margin: 0;
    }

    /* ì°¢ê¹€ ë°©ì§€ */
    table, tr, td, th { page-break-inside: avoid; }
    .no-break { page-break-inside: avoid; break-inside: avoid; }

    /* ===== í—¤ë” ===== */
    .topbar{
      display:flex;
      align-items:flex-start;         /* âœ… ê²¹ì¹¨ ë°©ì§€ */
      justify-content:space-between;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 2px solid #111;
    }
    .brand{
      display:flex;
      align-items:flex-start;         /* âœ… ê²¹ì¹¨ ë°©ì§€ */
      gap:10px;
    }
    .brand img{
      height: 26px;
      width: auto;
      margin-top: 2px;                /* âœ… ë„ì¥ ì‚´ì§ ë‚´ë ¤ì„œ í…ìŠ¤íŠ¸ì™€ ê²¹ì¹¨ ë°©ì§€ */
    }
    .brand .t1{ font-weight: 900; font-size: 14px; line-height: 1.2; }
    .brand .t2{ font-weight: 700; font-size: 11px; line-height: 1.2; color:#444; margin-top:2px; }

    .docmeta{
      text-align:right;
      font-size: 11px;
      color:#333;
      line-height: 1.4;
      white-space: nowrap;
    }
    .docmeta b{ color:#111; }

    /* ===== íƒ€ì´í‹€ ===== */
    .pdf-title{
      text-align:center;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 0.35em;
      margin: 12px 0 10px;
    }

    /* ===== ê²°ì¬ë€ ===== */
    .sign-wrap{
      width: 100%;                    /* âœ… WeasyPrintì—ì„œ flexë§Œìœ¼ë¡œ ì˜¤ë¥¸ìª½ ì •ë ¬ì´ ê°€ë” ê¹¨ì§ */
      text-align: right;              /* âœ… í™•ì‹¤íˆ ìš°ì¸¡ ì •ë ¬ */
      margin-top: 6px;
      margin-bottom: 12px;
    }
    .sign-table{
      display: inline-table;          /* âœ… text-align:rightì— ë°˜ì‘ */
      border-collapse: collapse;
      border:1px solid #111;
      table-layout: fixed;
      background:#fff;
      font-size: 11px;
    }
    .sign-table th, .sign-table td{
      border:1px solid #111;
      width: 78px;
      text-align:center;
      vertical-align: middle;
      padding: 0;
    }
    .sign-table th{
      background:#efefef;
      height: 22px;
      font-weight: 800;
    }
    .sign-table td{
      height: 54px;
    }
    .sign-time td{
      height: 22px;
      background:#efefef;
      font-size: 10px;
      color:#333;
    }
    .stamp-img{
      display:block;
      max-width: 64px;
      max-height: 44px;
      margin: 0 auto;
    }
    .stamp-svg-wrap{
      width: 54px;
      height: 54px;
      margin: 0 auto;
      color: #d60000;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .stamp-svg{ width:100%; height:100%; display:block; }

    /* ===== ë³¸ë¬¸ í‘œ ===== */
    .pdf-table{
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;
      margin-bottom: 10px;
    }
    .pdf-table th, .pdf-table td{
      border:1px solid #111;
      padding: 7px 8px;
      vertical-align: top;
    }
    .pdf-table th{
      width: 70px;
      text-align:center;
      background:#f6f6f6;
      font-weight: 800;
      white-space: nowrap;
    }

    /* ===== ë‚´ìš© ===== */
    .content{
      min-height: 140mm;
    }
    .content-value{
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;
      line-height: 1.6;
      font-size: 12px;
    }

    /* âœ… ì´ë¯¸ì§€: ì°¢ê¹€ ë°©ì§€ + í¬ê¸° ì œí•œ */
    .content-value img{
      max-width: 100% !important;
      height: auto !important;
      max-height: 240mm;
      object-fit: contain;
      display:block;
      margin: 8px 0;
      page-break-inside: avoid;
      break-inside: avoid;
    }

    /* í‘œê°€ ë“¤ì–´ì™€ë„ íŠ€ì§€ ì•Šê²Œ */
    .content-value table{
      width:100% !important;
      table-layout: fixed;
      border-collapse: collapse;
      page-break-inside: avoid;
    }
    .content-value th, .content-value td{
      border:1px solid #999;
      padding: 4px;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    /* ===== ì²¨ë¶€ ===== */
    .attach-box{
      border:1px solid #111;
      padding: 10px;
      background:#fafafa;
    }
    .attach-title{
      font-weight: 900;
      margin-bottom: 6px;
    }
    .attach-list{
      margin:0;
      padding-left: 16px;
    }
    .attach-list li{
      margin: 4px 0;
      line-height: 1.4;
    }
    .attach-meta{
      font-size: 10px;
      color:#666;
      margin-left: 6px;
    }

    a { color:#111; text-decoration: underline; }
  </style>
</head>

<body>
  <!-- ìƒë‹¨ë°” -->
  <div class="topbar no-break">
    <div class="brand">
      <img src="{% static 'img/saecheon_stamp.png' %}" alt="stamp">
      <div>
        <div class="t1">ë‚´ì‡¼ë‚ ìƒˆì²œë…„</div>
        <div class="t2">ì „ìê²°ì¬ Â· ì¶œë ¥ë³¸(PDF)</div>
      </div>
    </div>

    <div class="docmeta">
      <div><b>ë¬¸ì„œë²ˆí˜¸</b> #{{ approval.id }}</div>
      <div><b>ì‘ì„±ì¼</b> {{ approval.created_at|localtime|date:"Y-m-d H:i" }}</div>
      {% if route.status == "completed" %}
        <div><b>ì™„ë£Œ</b> {{ route.completed_at|date:"Y-m-d H:i"|default:"-" }}</div>
      {% elif route.status == "rejected" %}
        <div><b>ë°˜ë ¤</b> {{ route.rejected_at|date:"Y-m-d H:i"|default:"-" }}</div>
      {% else %}
        <div><b>ìƒíƒœ</b> ì§„í–‰ì¤‘</div>
      {% endif %}
    </div>
  </div>

  <!-- íƒ€ì´í‹€ -->
  <div class="pdf-title no-break">í’ˆ ì˜ ì„œ</div>

  <!-- ê²°ì¬ë€ -->
  <div class="sign-wrap no-break">
    <table class="sign-table">
      <tr>
        {% for s in steps %}
          <th>
            {% if s.role == "drafter" %}ê¸°ì•ˆ
            {% elif s.role == "admin" %}ì´ë¬´
            {% elif s.role == "auditor" %}ê°ì‚¬
            {% elif s.role == "chairman" %}íšŒì¥
            {% else %}{{ s.role }}{% endif %}
          </th>
        {% endfor %}
      </tr>

      <tr>
        {% for s in steps %}
          <td>
            {% if s.state == "approved" %}
              {% if s.stamp_image %}
                <img src="{{ s.stamp_image.url }}" class="stamp-img" alt="stamp">
              {% else %}
                <div class="stamp-svg-wrap">
                  {% if route.template_code == "ADMIN_FINAL" and s.role == "admin" %}
                    <svg viewBox="0 0 120 120" class="stamp-svg" aria-label="ì „ê²°">
                      <rect x="10" y="10" width="100" height="100" fill="none" stroke="currentColor" stroke-width="6"/>
                      <text x="60" y="50" text-anchor="middle" font-size="22" font-weight="900" fill="currentColor">ì „ê²°</text>
                      <text x="60" y="80" text-anchor="middle" font-size="22" font-weight="900" fill="currentColor">ìŠ¹ì¸</text>
                    </svg>
                  {% else %}
                    <svg viewBox="0 0 120 120" class="stamp-svg" aria-label="ìŠ¹ì¸">
                      <rect x="10" y="10" width="100" height="100" fill="none" stroke="currentColor" stroke-width="6"/>
                      <text x="60" y="52" text-anchor="middle" font-size="22" font-weight="900" fill="currentColor">ìŠ¹ì¸</text>
                      <text x="60" y="82" text-anchor="middle" font-size="18" font-weight="900" fill="currentColor">
                        {% if s.role == "drafter" %}ê¸°ì•ˆ{% elif s.role == "admin" %}ì´ë¬´{% elif s.role == "auditor" %}ê°ì‚¬{% elif s.role == "chairman" %}íšŒì¥{% else %}{{ s.role }}{% endif %}
                      </text>
                    </svg>
                  {% endif %}
                </div>
              {% endif %}
            {% elif s.state == "rejected" %}
              <img src="{% static 'img/reject_img.jpg' %}" class="stamp-img" alt="ë°˜ë ¤">
            {% else %}
              &nbsp;
            {% endif %}
          </td>
        {% endfor %}
      </tr>

      <tr class="sign-time">
        {% for s in steps %}
          <td>
            {% if s.acted_at %}
              {{ s.acted_at|localtime|date:"n/j H:i" }}
            {% else %}
              &nbsp;
            {% endif %}
          </td>
        {% endfor %}
      </tr>
    </table>
  </div>

  <!-- ê¸°ë³¸ ì •ë³´ -->
  <table class="pdf-table no-break">
    <tr>
      <th>ì†Œì†</th><td>{{ approval.department }}</td>
      <th>ì„±ëª…</th><td>{{ approval.name }}</td>
    </tr>
  </table>

  <table class="pdf-table no-break">
    <tr>
      <th>ì œëª©</th>
      <td>{{ approval.title }}</td>
    </tr>
  </table>

  <!-- ë‚´ìš© -->
  <table class="pdf-table">
    <tr>
      <th>ë‚´ìš©</th>
      <td class="content">
        <div class="content-value">{{ content_html|safe }}</div>
      </td>
    </tr>
  </table>

  <!-- ë°˜ë ¤ ì‚¬ìœ (ìˆì„ ë•Œë§Œ) -->
  {% for s in steps %}
    {% if s.state == "rejected" and s.reject_reason %}
      <table class="pdf-table no-break">
        <tr>
          <th>ë°˜ë ¤</th>
          <td>
            <b>
              {% if s.role == "drafter" %}ê¸°ì•ˆ{% elif s.role == "admin" %}ì´ë¬´{% elif s.role == "auditor" %}ê°ì‚¬{% elif s.role == "chairman" %}íšŒì¥{% else %}{{ s.role }}{% endif %}
            </b><br>
            <div style="margin-top:6px; white-space:pre-wrap;">{{ s.reject_reason }}</div>
          </td>
        </tr>
      </table>
    {% endif %}
  {% endfor %}

  <!-- ì²¨ë¶€ -->
{% if attachments %}
  <div class="attach-box no-break">
    <div class="attach-title">ğŸ“ ì²¨ë¶€íŒŒì¼</div>
    <ul class="attach-list">
      {% for f in attachments %}
        <li>
          {{ f.original_name|default:f.file.name }}
          <span class="attach-meta">{{ f.uploaded_at|date:"Y-m-d H:i" }}</span>
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}
</body>
</html>