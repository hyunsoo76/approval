{% extends "base.html" %}

{% block title %}내쇼날새천년 전자결재{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="bg-light">
  <div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">품의 리스트 (v2)</h4>
      <a class="btn btn-primary" href="/approval/v2/new/">+ 새 기안</a>
    </div>

    <form class="row g-2 mb-3" method="get" action="/approval/v2/">
      <div class="col-12 col-md-3">
        <select class="form-select" name="status">
          <option value="all" {% if status == "all" %}selected{% endif %}>전체</option>
          <option value="in_progress" {% if status == "in_progress" %}selected{% endif %}>진행중</option>
          <option value="completed" {% if status == "completed" %}selected{% endif %}>완료</option>
          <option value="rejected" {% if status == "rejected" %}selected{% endif %}>반려</option>
        </select>
      </div>
      <div class="col-12 col-md-7">
        <input class="form-control" name="q" value="{{ q }}" placeholder="검색: 제목/부서/기안자">
      </div>
      <div class="col-12 col-md-2 d-grid">
        <button class="btn btn-outline-dark" type="submit">검색</button>
      </div>
    </form>

    <!-- 모바일 카드 -->
    <div class="d-md-none">
      {% for row in approvals_ctx %}
        {% with a=row.a route=row.route %}
          <div class="card shadow-sm mb-2" onclick="location.href='/approval/v2/{{ a.id }}/'" style="cursor:pointer;">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div class="me-2">
                  <div class="small text-muted">#{{ a.id }}</div>
                  <div class="fw-semibold" style="line-height:1.25;">{{ a.title }}</div>
                </div>
                <div class="text-end">
                  {% if route and route.status == "in_progress" %}
                    <span class="badge text-bg-warning">진행중</span>
                  {% elif route and route.status == "completed" %}
                    <span class="badge text-bg-success">완료</span>
                  {% elif route and route.status == "rejected" %}
                    <span class="badge text-bg-danger">반려</span>
                  {% else %}
                    <span class="badge text-bg-secondary">{% if route %}{{ route.status }}{% else %}-{% endif %}</span>
                  {% endif %}
                </div>
              </div>

              <div class="mt-2 small text-muted">{{ a.department }} · {{ a.name }}</div>
              <div class="small text-muted">기안일: {{ a.created_at|date:"Y-m-d" }}</div>

              <div class="mt-1">
                <span class="badge text-bg-light border">현재 단계: {{ row.current_step_label }}</span>
              </div>
            </div>
          </div>
        {% endwith %}
      {% empty %}
        <div class="card shadow-sm">
          <div class="card-body text-center text-muted py-5">문서가 없습니다</div>
        </div>
      {% endfor %}
    </div>

    <!-- PC/태블릿 표 -->
    <div class="card shadow-sm d-none d-md-block">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:90px;">ID</th>
              <th>제목</th>
              <th style="width:160px;">회원사</th>
              <th style="width:120px;">기안자</th>
              <th style="width:130px;">기안일</th>
              <th style="width:140px;">상태</th>
              <th style="width:140px;">현재 단계</th>
            </tr>
          </thead>
          <tbody>
            {% for row in approvals_ctx %}
              {% with a=row.a route=row.route %}
                <tr onclick="location.href='/approval/v2/{{ a.id }}/'" style="cursor:pointer;">
                  <td class="text-muted">#{{ a.id }}</td>
                  <td><strong>{{ a.title }}</strong></td>
                  <td>{{ a.department }}</td>
                  <td>{{ a.name }}</td>
                  <td>{{ a.created_at|date:"Y-m-d" }}</td>
                  <td>
                    {% if route and route.status == "in_progress" %}
                      <span class="badge text-bg-warning">진행중</span>
                    {% elif route and route.status == "completed" %}
                      <span class="badge text-bg-success">완료</span>
                    {% elif route and route.status == "rejected" %}
                      <span class="badge text-bg-danger">반려</span>
                    {% else %}
                      <span class="badge text-bg-secondary">{% if route %}{{ route.status }}{% else %}-{% endif %}</span>
                    {% endif %}
                  </td>
                  <td>{{ row.current_step_label }}</td>
                </tr>
              {% endwith %}
            {% empty %}
              <tr><td colspan="7" class="text-center text-muted py-5">문서가 없습니다</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="text-muted mt-2" style="font-size:12px;">
      최대 200건 표시(추후 페이지네이션 추가)
    </div>
  </div>
</div>
{% endblock %}
